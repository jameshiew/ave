---
stages:
  - lint
  - check
  - build
  - test
  - release

variables:
  CARGO_HOME: $CI_PROJECT_DIR/cargo

cache:
  paths:
    - cargo/

lint:
  image: rust:1.42.0
  stage: lint
  script:
    - rustup component add rustfmt
    - cargo fmt -- --check
    - rustup component add clippy
    - cargo clippy --all-targets --all-features -- -D warnings
  artifacts:
    expire_in: 1 day
    paths:
      - target/

check:
  image: rust:1.42.0
  stage: check
  script:
    - cargo check --verbose
    - rustup component add clippy
    - cargo clippy --all-targets --all-features -- -D warnings
  artifacts:
    expire_in: 1 hour
    paths:
      - target/

build:
  image: rust:1.42.0
  stage: test
  script:
    - cargo build --verbose --workspace
  artifacts:
    expire_in: 1 hour
    paths:
      - target/

test:
  image: rust:1.42.0
  stage: test
  script:
    - cargo test --verbose --workspace
  artifacts:
    expire_in: 1 hour
    paths:
      - target/

release:
  image: rust:1.42.0
  stage: release
  script:
    - cargo clean --verbose
    - cargo build --release --verbose --workspace
  rules:
      - if: 'CI_COMMIT_REF_NAME =~ /^(master|develop)$/'
        when: always
  artifacts:
    paths:
      - target/release/ave
